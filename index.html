<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Flappy Bird Structure</title>

    <style>
        canvas {
            border: 2px solid black;
        }
    </style>
</head>

<body>

    <canvas id="canvas" width="1600" height="900"></canvas>
    <h1 id="score_card">Score: 0</h1>

    <script>

        //////////////////////////////////////////////////////
        // GLOBAL VARIABLES
        //////////////////////////////////////////////////////

        let canvas, ctx;

        let lastTime = 0;
        let gameState = "playing";

        let score = 0;
        let scoreCard = document.getElementById("score_card");
        let highScore = 0;

        //////////////////////////////////////////////////////
        // GAME OBJECTS
        //////////////////////////////////////////////////////

        let bird = {
            x: 100,
            y: 300,
            length: 100,
            width: 60,
            vel: 0,
            gravity: 2000,
            jump: -700
        };

        let pillars = [];

        let pillarSpeed = 600;
        let spawnInterval = 800;
        let lastSpawnTime = 0;

        //////////////////////////////////////////////////////
        // INIT
        //////////////////////////////////////////////////////

        function init() {
            canvas = document.getElementById("canvas");
            ctx = canvas.getContext("2d");


            highScore = Number(localStorage.getItem("highScore")) || 0;
            scoreCard.textContent = `Score: 0 | High: ${highScore}`;


            requestAnimationFrame(gameLoop);
        }

        //////////////////////////////////////////////////////
        // GAME LOOP
        //////////////////////////////////////////////////////



        function gameLoop(time) {

            if (!lastTime) {
                lastTime = time;
                requestAnimationFrame(gameLoop);
                return;
            }

            let dt = (time - lastTime) / 1000;
            lastTime = time;

            if (gameState === "playing") {
                update(dt, time);
            }

            draw();
            requestAnimationFrame(gameLoop);
        }



        //////////////////////////////////////////////////////
        // UPDATE
        //////////////////////////////////////////////////////

        function update(dt, time) {
            updateBird(dt);
            updatePillars(dt);
            spawnPillars(time);
            checkCollision(dt);
            updateScore();
        }

        //////////////////////////////////////////////////////
        // DRAW
        //////////////////////////////////////////////////////

        function draw() {
            clearCanvas();
            drawBird();
            drawPillars();

            if (gameState === "start") {
                ctx.font = "60px Arial";
                ctx.fillText("FLAPPY BIRD", 550, 350);
                ctx.font = "40px Arial";
                ctx.fillText("Press SPACE to START", 530, 420);
            }

            if (gameState === "over") {
                ctx.font = "60px Arial";
                ctx.fillText("GAME OVER", 600, 350);
                ctx.font = "40px Arial";
                ctx.fillText("Press R to Restart", 620, 420);
            }
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, 16000, 900);
        }



        //////////////////////////////////////////////////////
        // BIRD LOGIC
        //////////////////////////////////////////////////////

        function updateBird(dt) {
            bird.vel += bird.gravity * dt;
            bird.y += bird.vel * dt;



        }

        function drawBird() {
            ctx.fillRect(bird.x, bird.y, bird.width, bird.length);
        }
        //////////////////////////////////////////////////////
        // PILLARS
        //////////////////////////////////////////////////////

        function spawnPillars(time) {
            if (time - lastSpawnTime > spawnInterval) {
                let height = Math.random() * 400 + 100;

                pillars.push({
                    x: canvas.width,
                    height: height,
                    gap: 300,
                    passed: false
                });

                lastSpawnTime = time;
            }
        }

        function updatePillars(dt) {
            pillars.forEach(p => {
                p.x -= pillarSpeed * dt;
            });


            pillars = pillars.filter(p => p.x + 120 > 0);
        }

        function drawPillars() {
            pillars.forEach(p => {
                // top
                ctx.fillRect(p.x, 0, 120, p.height);

                // bottom
                ctx.fillRect(
                    p.x,
                    p.height + p.gap,
                    120,
                    canvas.height - (p.height + p.gap)
                );
            });
        }

        //////////////////////////////////////////////////////////
        ///// Collisions
        /////////////////////////////////////////////////////////
        function checkCollision(dt) {
            borderCollision();
            pillarCollision();


        }

        // ground collision
        function borderCollision() {
            if (bird.y + bird.length > canvas.height) {
                bird.y = canvas.height - bird.length;
                gameOver();
            }
            if (bird.y < 0) {
                gameOver();
            }
        }

        // Pillar collision
        function pillarCollision() {
            let birdLeft = bird.x;
            let birdRight = bird.x + bird.width;
            let birdTop = bird.y;
            let birdBottom = bird.y + bird.length;


            pillars.forEach((p) => {
                let P_left = p.x
                let P_right = p.x + 120
                let P_UpperTop = 0
                let P_Upperbottom = p.height
                let P_LowerTop = p.height + p.gap
                let P_Lowerbotton = canvas.height

                if ((birdRight > P_left && birdLeft < P_right) &&
                    ((birdTop < P_Upperbottom && birdBottom > P_UpperTop) || (birdBottom > P_LowerTop && birdTop < P_Lowerbotton))) {
                    gameOver();
                }

            })

        }

        /////////////////////////////////////////////////////
        //// Score 
        /////////////////////////////////////////////////////
        function updateScore() {
            pillars.forEach(p => {
                if (!p.passed && p.x + 120 < bird.x) {
                    p.passed = true;
                    score++;
                    scoreCard.textContent = `Score: ${score} | High: ${highScore}`;

                }
            });
        }





        //////////////////////////////////////////////////////
        // GAME OVER And Restart
        //////////////////////////////////////////////////////

        function gameOver() {
            gameState = "over";
            console.log("Game Over");

            if (score > highScore) {
                highScore = score;
                localStorage.setItem("highScore", highScore);
            }

        }

        function resetGame() {
            bird.y = 300;
            bird.vel = 0;

            pillars = [];
            score = 0;
            scoreCard.textContent = `Score: ${score} | High: ${highScore}`;

            lastTime = 0;

        }


        //////////////////////////////////////////////////////
        // INPUT
        //////////////////////////////////////////////////////

        window.addEventListener("keydown", (e) => {
            if (e.code === "Space") {

                if (gameState === "start") {
                    gameState = "playing";
                    bird.vel = bird.jump;
                }

                else if (gameState === "playing") {
                    bird.vel = bird.jump;
                }
            }

            if (e.code === "KeyR" && gameState === "over") {
                resetGame();
                gameState = "start";
            }
        });

        //////////////////////////////////////////////////////
        // START
        //////////////////////////////////////////////////////

        init();

    </script>
</body>

</html>